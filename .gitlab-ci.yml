image: willhallonline/ansible:latest

variables:
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_CONFIG: ansible.cfg
  ANSIBLE_VAULT_PASSWORD_FILE: $ANSIBLE_VAULT_PASSWORD

stages:
  - deploy

# ==================================================
# ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ ÐžÐšÐ Ð£Ð–Ð•ÐÐ˜Ð¯
# ==================================================
.setup_env_template: &setup_env
  before_script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - if [ -z "$SSH_PRIVATE_KEY" ]; then echo "âŒ MISSING SSH_PRIVATE_KEY"; exit 1; fi
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

# ==================================================
# FULL DEPLOY
# ==================================================
deploy_all:
  stage: deploy
  <<: *setup_env
  script:
    - echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹..."
    - ansible-playbook playbooks/site.yml
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - ansible.cfg
        - .gitlab-ci.yml
        - playbooks/site.yml
        - inventory/**/*
        - roles/common/**/*
        - roles/deploy_stack/**/*

# ==================================================
# NODE DEPLOY
# ==================================================

deploy_mgmt:
  stage: deploy
  <<: *setup_env
  script:
    - echo "ðŸ›  ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Management Node..."
    - ansible-playbook playbooks/site.yml --limit mgmt
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - roles/mgmt/**/* # Ð›Ð¾Ð³Ð¸ÐºÐ° Ñ€Ð¾Ð»Ð¸ Mgmt
        - templates/mgmt/**/* # Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ Mgmt
        - files/traefik_dynamic/**/* # Ð¡Ñ‚Ð°Ñ‚Ð¸ÐºÐ° Ð´Ð»Ñ Mgmt
        - files/prometheus_config/**/*
        - files/vpn_build/**/*
        - files/glance_config/**/*
        - files/loki_config/**/*
        - files/grafana_provisioning/**/*

deploy_worker:
  stage: deploy
  <<: *setup_env
  script:
    - echo "ðŸ›  ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Worker Node..."
    - ansible-playbook playbooks/site.yml --limit worker
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - roles/worker/**/* # Ð›Ð¾Ð³Ð¸ÐºÐ° Ñ€Ð¾Ð»Ð¸ Worker
        - templates/worker/**/* # Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ Worker
        - files/obsidian_publisher/**/*

deploy_backup:
  stage: deploy
  <<: *setup_env
  script:
    - echo "ðŸ›  ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Backup Node..."
    - ansible-playbook playbooks/site.yml --limit backup
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - roles/backup/**/* # Ð›Ð¾Ð³Ð¸ÐºÐ° Ñ€Ð¾Ð»Ð¸ Backup
        - templates/backup/**/* # Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ Backup
